name: Sync StaPH-B vs nf-core Missing Tools
on:
  workflow_dispatch:  
  schedule:
    - cron: '0 0 1 * *'

jobs:
  check-and-issue:
    runs-on: ubuntu-latest
    permissions:
      issues: write        
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Nextflow
        uses: nf-core/setup-nextflow@v2
        with:
          version: 'latest-stable'

      - name: Install nf-core CLI
        run: pip install nf-core

      - name: Fetch nf-core modules
        run: |
          nf-core modules list remote --json \
          | jq -r '.modules[]' \
          | cut -d '/' -f1 \
          | tr '[:upper:]' '[:lower:]' \
          | sort \
          | uniq > nfcore_list.txt
          cat nfcore_list.txt

      - name: Fetch StaPH-B tool list
        run: |
          curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          https://api.github.com/repos/StaPH-B/docker-builds/contents/ \
          | jq -r '.[] | select(.type == "dir" and ( .name | startswith(".") | not )) | .name' \
          | tr '[:upper:]' '[:lower:]' \
          | sort \
          | uniq > staphb_list.txt

          cat staphb_list.txt
          
      - name: Compare StaPH-B and NF-CORE
        run: |
          comm -23 staphb_list.txt nfcore_list.txt > missing_tools.txt

      - name: Prepare Issue Text
        run: |
          COUNT=$(wc -l < missing_tools.txt)
          echo "## Missing Software Report ($(date +'%Y-%m-%d'))" > issue_body.md
          echo "Found **$COUNT** tools in [StaPH-B/docker-builds](https://github.com/StaPH-B/docker-builds) that do not have corresponding modules in [nf-core/modules](https://github.com/nf-core/modules)." >> issue_body.md
          echo "" >> issue_body.md
          echo "### Missing Tools Checklist:" >> issue_body.md
          sed 's/^/- [ ] /' missing_tools.txt >> issue_body.md
          
          # Also output to the workflow summary for quick viewing
          cat issue_body.md >> $GITHUB_STEP_SUMMARY

      - name: Create or Update Issue
        uses: peter-evans/create-issue-from-file@v5
        with:
          title: "Gap Analysis: StaPH-B Tools Missing from nf-core"
          content-filepath: ./issue_body.md
          labels: |
            enhancement
            automated-report
