name: Sync StaPH-B vs nf-core Missing Tools
on:
  workflow_dispatch:  
  schedule:
    - cron: '0 0 1 * *'

jobs:
  check-and-issue:
    runs-on: ubuntu-latest
    permissions:
      issues: write        
    steps:
      - uses: actions/checkout@main
        with:
          repository: StaPH-B/docker-builds

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Nextflow
        uses: nf-core/setup-nextflow@v2
        with:
          version: 'latest-stable'

      - name: Install nf-core CLI
        run: pip install nf-core

      - name: Fetch nf-core modules
        run: |
          nf-core modules list remote | \
            grep -v "Module Name" | \
            grep -v ───────── | \
            awk '{print $2}' | \
            cut -f 1 -d "/" | \
            sed 's/_//g' | \
            sed 's/-//g' | \
            sort | \
            uniq > nfcore_list.txt
          cat nfcore_list.txt

      - name: Fetch StaPH-B tool list
        run: |
            ls build-files/*/*/Dockerfile | \
              cut -f 2 -d / | \
              grep -v artic-ncov2019 | \
              grep -v berrywood-report-env | \
              grep -v canu-racon | \
              grep -v cbird-util | \
              grep -v cluster-report-env | \
              grep -v datasets-sars-cov-2 | \
              grep -v bbtools | \
              grep -v enabrowsertools | \
              grep -v grandeur_ref | \
              grep -v tostadas | \
              grep -v polkapox | \
              grep -v parallel-perl | \
              grep -v iqtree | \
              grep -v pycirclize | \
              grep -v pandas | \
              grep -v pangoaliasor | \
              sed 's/_//g' | \
              sed 's/-//g' | \
              grep -v cutshawreportenv | \
              grep -v emmtypingtool | \
              grep -v ncbiamrfinderplus | \
              grep -v shovillse | \
              sort | \
              uniq > staphb_list.txt

            cat staphb_list.txt
          
      - name: Compare StaPH-B and NF-CORE
        run: |
          grep -Fx -f nfcore_list.txt staphb_list.txt > included_tools.txt

          cat included_tools.txt | \
            awk '{print "This is already part of nf-core modules: " $0 }'
          grep -Fvx -f nfcore_list.txt staphb_list.txt > missing_tools.txt

      - name: Prepare Issue Text
        run: |
          COUNT=$(wc -l < missing_tools.txt)
          echo "## Missing Software Report ($(date +'%Y-%m-%d'))" > issue_body.md
          echo "Found **$COUNT** tools in [StaPH-B/docker-builds](https://github.com/StaPH-B/docker-builds) that do not have corresponding modules in [nf-core/modules](https://github.com/nf-core/modules)." >> issue_body.md
          echo "" >> issue_body.md
          echo "### Missing Tools Checklist:" >> issue_body.md
          sed 's/^/- [ ] /' missing_tools.txt >> issue_body.md
          
          # Also output to the workflow summary for quick viewing
          cat issue_body.md >> $GITHUB_STEP_SUMMARY

      - name: Create or Update Issue
        uses: peter-evans/create-issue-from-file@v5
        with:
          title: "StaPH-B Tools Missing from nf-core"
          content-filepath: ./issue_body.md
          labels: |
            enhancement
            automated-report
